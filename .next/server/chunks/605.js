exports.id=605,exports.ids=[605],exports.modules={2754:(e,t,a)=>{"use strict";a.a(e,async(e,r)=>{try{a.d(t,{A:()=>d});var n=a(8732),s=a(2015),i=a(9918),o=a.n(i),l=a(1428),c=a(4233),u=e([l]);l=(u.then?(await u)():u)[0];let d=()=>{let[e,t]=(0,s.useState)(null),a=(0,c.useRouter)();(0,s.useEffect)(()=>{(async()=>{if("true"===localStorage.getItem("loggedOut")){console.log("Skipping auth check due to recent logout"),t("Guest");return}try{console.log("Checking user, browser cookies:",document.cookie);let e=await l.default.get("https://s33.ierg4210.ie.cuhk.edu.hk/auth/user",{withCredentials:!0});console.log("Fetched user:",e.data);let r=localStorage.getItem("expectedUserId");if(r&&e.data.userId.toString()!==r){console.warn(`User ID mismatch! Expected: ${r}, Got: ${e.data.userId}. Multiple authToken cookies may exist.`),await l.default.post("https://s33.ierg4210.ie.cuhk.edu.hk/auth/logout",{},{withCredentials:!0}),localStorage.setItem("loggedOut","true"),t("Guest"),a.push("/login");return}t("admin"===e.data.role?"Admin":"User")}catch(e){console.error("User not authenticated:",e.response?.data||e),t("Guest")}})()},[a]);let r=async()=>{try{console.log("Sending logout request, browser cookies:",document.cookie);let e=await l.default.post("https://s33.ierg4210.ie.cuhk.edu.hk/auth/logout",{},{withCredentials:!0});console.log("Logout response:",e.data),t("Guest"),localStorage.setItem("loggedOut","true"),localStorage.removeItem("expectedUserId"),localStorage.removeItem("lastLogin"),localStorage.removeItem("redirectAfterLogin"),document.cookie="authToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="sessionID=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="authToken=; Path=/auth; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="sessionID=; Path=/auth; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="authToken=; Path=/api; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="sessionID=; Path=/api; Expires=Thu, 01 Jan 1970 00:00:00 GMT",a.push("/login")}catch(e){console.error("Logout failed:",e.response?.data||e)}};return(0,n.jsx)("header",{children:(0,n.jsxs)("nav",{className:"navbar",children:[(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:(0,n.jsx)(o(),{href:"/",children:"Home"})}),(0,n.jsxs)("li",{className:"category",children:[(0,n.jsx)("a",{href:"#",children:"Category"}),(0,n.jsxs)("ul",{className:"cate",children:[(0,n.jsx)("li",{children:(0,n.jsx)(o(),{href:"/smartphone",children:"Smartphone"})}),(0,n.jsx)("li",{children:(0,n.jsx)(o(),{href:"/laptop",children:"Laptop"})})]})]}),(0,n.jsx)("li",{children:(0,n.jsx)(o(),{href:"/member-portal",children:"Member Portal"})}),"Admin"===e&&(0,n.jsx)("li",{children:(0,n.jsx)(o(),{href:"/admin",children:"Admin Panel"})})]}),(0,n.jsx)("div",{className:"user-actions",children:null===e?(0,n.jsx)("span",{children:"Loading..."}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("span",{className:"user-greeting",children:["Welcome, ",e]}),"Guest"!==e?(0,n.jsx)("button",{className:"logout-btn",onClick:r,children:"Logout"}):(0,n.jsx)(o(),{href:"/login",children:(0,n.jsx)("button",{className:"login-btn",children:"Login"})}),(0,n.jsx)(o(),{href:"/changepwd",children:(0,n.jsx)("button",{className:"pwd",children:"Reset"})})]})})]})})};r()}catch(e){r(e)}})},3761:()=>{},4176:(e,t,a)=>{"use strict";a.d(t,{A:()=>r});let r=new(a(4735)).EventEmitter},7325:e=>{e.exports={cart_container:"CartButton_cart_container__5vrp7",cart_button:"CartButton_cart_button__8zPgj"}},7522:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>n});var r=a(8732);a(7982),a(3761);let n=function({Component:e,pageProps:t}){return(0,r.jsx)(e,{...t})}},7982:()=>{},9069:e=>{e.exports={CartPopup:"CartPopup_CartPopup__bexWI"}},9117:(e,t,a)=>{"use strict";a.d(t,{A:()=>f});var r=a(8732),n=a(2015),s=a.n(n),i=a(9069),o=a.n(i),l=a(4176),c=a(9918),u=a.n(c),d=a(4233);let h=()=>{let[e,t]=(0,n.useState)([]),[a,i]=(0,n.useState)([]),[c,h]=(0,n.useState)(null),[p,m]=(0,n.useState)(!1),[g,x]=(0,n.useState)(null),[y,f]=(0,n.useState)({items:[]}),j=(0,n.useRef)(null),A=(0,d.useRouter)(),k=()=>{let e=JSON.parse(localStorage.getItem("cart")||"[]").map(e=>({...e,price:"string"==typeof e.price?parseFloat(e.price):e.price}));console.log("Fetched cart items:",e),t(e)},S=async()=>{try{let e=await fetch("https://s33.ierg4210.ie.cuhk.edu.hk/api/discounts");if(!e.ok)throw Error(`Failed to fetch discounts: ${e.status}`);let t=await e.json();if(!Array.isArray(t)){console.error("Discounts response is not an array:",t),i([]);return}i(t)}catch(e){console.error("Error fetching discounts:",e),i([])}};(0,n.useEffect)(()=>(k(),S(),l.A.on("cartUpdated",k),()=>{l.A.removeListener("cartUpdated",k)}),[]);let v=()=>{localStorage.setItem("cart",JSON.stringify([])),t([]),l.A.emit("cartUpdated")},b=(a,r)=>{let n=e.map(e=>e.pid===a?{...e,quantity:r}:e);t(n),localStorage.setItem("cart",JSON.stringify(n)),l.A.emit("cartUpdated")},I=(e,t)=>{let a=parseInt(t.target.value,10);a>=1&&b(e,a)},w=a=>{h(a),setTimeout(()=>{let r=e.filter(e=>e.pid!==a);t(r),localStorage.setItem("cart",JSON.stringify(r)),l.A.emit("cartUpdated"),h(null)},300)},N=e=>{let t=a.find(t=>t.pid===e.pid);if(!t)return e.price*e.quantity;if("buy_x_get_y_free"===t.type){let{buy_quantity:a,free_quantity:r}=t.condition,n=a+r,s=Math.floor(e.quantity/n);return(s*a+e.quantity%n)*e.price}if("tiered_pricing"===t.type){let{tiers:a}=t.condition,r=a.sort((e,t)=>t.quantity-e.quantity),n=e.quantity,s=0;for(;n>0;){let e=r.find(e=>e.quantity<=n);if(!e)break;let t=Math.floor(n/e.quantity);s+=t*e.total_price,n-=t*e.quantity}return s+n*e.price}return e.price*e.quantity},T=async e=>{if(e.preventDefault(),!p){m(!0),x(null);try{let e=JSON.parse(localStorage.getItem("cart")||"[]");if(0===e.length){x("Cart is empty."),m(!1);return}let a=e.map(e=>e.pid),r=await fetch("https://s33.ierg4210.ie.cuhk.edu.hk/api/products/validate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pids:a}),credentials:"include"});if(!r.ok)throw Error(`Failed to fetch product data: ${r.status}`);let n=await r.json();console.log("Fetched products from database:",n);let s=new Map(n.map(e=>[e.pid,{name:e.name,price:parseFloat(e.price)}])),i=e.filter(e=>s.has(e.pid)).map(e=>({...e,name:s.get(e.pid).name,price:s.get(e.pid).price}));if(i.length!==e.length&&x("Some items in your cart are invalid and have been removed."),t(i),localStorage.setItem("cart",JSON.stringify(i)),l.A.emit("cartUpdated"),0===i.length){x("No valid items in cart."),m(!1);return}let o=null;console.log("Checking user session, browser cookies:",document.cookie);let c=await fetch("https://s33.ierg4210.ie.cuhk.edu.hk/api/get-user",{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});if(console.log("Get user response:",{status:c.status,headers:Object.fromEntries(c.headers.entries()),ok:c.ok,body:await c.clone().json().catch(()=>({}))}),c.ok){let e=await c.json(),t=localStorage.getItem("expectedUserId");if(t&&e.userId.toString()!==t){console.warn(`User ID mismatch in checkout! Expected: ${t}, Got: ${e.userId}. Forcing logout.`),await fetch("https://s33.ierg4210.ie.cuhk.edu.hk/auth/logout",{method:"POST",credentials:"include"}),localStorage.setItem("loggedOut","true"),localStorage.removeItem("expectedUserId"),A.push("/login"),m(!1);return}o=e.userId||null,console.log("User fetched successfully:",e)}else if(console.warn("Failed to fetch user, status:",c.status),confirm("Please log in to proceed with checkout. Continue as guest?"))o=null;else{localStorage.setItem("redirectAfterLogin",window.location.pathname),A.push("/login"),m(!1);return}console.log("Submitting cart:",i,"User ID:",o);let u=await fetch("https://s33.ierg4210.ie.cuhk.edu.hk/api/validate-order",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({cart:i.map(e=>({pid:e.pid,quantity:e.quantity})),user_id:o})});if(!u.ok){let e=await u.json();throw Error(`Order validation failed: ${e.error||u.status}`)}let{orderId:d,digest:h}=await u.json();console.log("Order validated:",{orderId:d,digest:h}),localStorage.setItem("lastOrderId",d.toString()),f({invoice:d.toString(),custom:d.toString(),returnUrl:`https://s33.ierg4210.ie.cuhk.edu.hk/success?invoice=${d}`,cancelUrl:"https://s33.ierg4210.ie.cuhk.edu.hk/cancel",items:i.map(e=>({name:e.name,pid:e.pid.toString(),amount:(N(e)/e.quantity).toFixed(2),quantity:e.quantity.toString()}))}),setTimeout(()=>{j.current&&document.contains(j.current)?(console.log("Submitting PayPal form via ref:",j.current.outerHTML),j.current.submit(),v()):(console.error("Form is not connected to the DOM"),x("Failed to submit payment form. Please try again."),m(!1))},100)}catch(e){console.error("Checkout error:",e),x("System error. Please try again later."),m(!1)}}},C=e.reduce((e,t)=>e+N(t),0);return(0,r.jsxs)("div",{className:o().CartPopup,children:[(0,r.jsx)("h4",{children:"Shopping Cart"}),g&&(0,r.jsx)("p",{className:o().Error,children:g}),(0,r.jsx)("ul",{children:e.map(e=>(0,r.jsxs)("li",{className:`${o().CartItem} ${e.pid===c?o().removing:""}`,children:[(0,r.jsx)(u(),{href:`/product/${e.pid}`,children:(0,r.jsx)("span",{className:o().ItemName,children:e.name})}),(0,r.jsx)("input",{type:"number",value:e.quantity,min:"1",onChange:t=>I(e.pid,t),className:o().QuantityInput}),(0,r.jsx)("span",{className:o().ItemTime,children:"\xd7"}),(0,r.jsxs)("span",{className:o().ItemPrice,children:["$",e.price.toFixed(2)]}),(0,r.jsx)("span",{className:o().ItemEqual,children:"="}),(0,r.jsxs)("span",{className:o().ItemTotal,children:["$",N(e).toFixed(2)]}),(0,r.jsx)("button",{className:o().ItemRemove,onClick:()=>w(e.pid),children:"-"})]},e.pid))}),0===e.length&&(0,r.jsx)("p",{children:"Your cart is empty."}),(0,r.jsx)("hr",{}),(0,r.jsxs)("h2",{className:o().TotalPrice,children:["Total: $",C.toFixed(2)]}),(0,r.jsxs)("div",{className:o().ButtonContainer,children:[(0,r.jsxs)("form",{id:"paypal-form",ref:j,action:"https://www.sandbox.paypal.com/cgi-bin/webscr",method:"post",onSubmit:T,children:[(0,r.jsx)("input",{type:"hidden",name:"cmd",value:"_cart"}),(0,r.jsx)("input",{type:"hidden",name:"upload",value:"1"}),(0,r.jsx)("input",{type:"hidden",name:"business",value:"sb-6odog38870896@business.example.com"}),(0,r.jsx)("input",{type:"hidden",name:"charset",value:"utf-8"}),(0,r.jsx)("input",{type:"hidden",name:"currency_code",value:"USD"}),y.invoice&&(0,r.jsx)("input",{type:"hidden",name:"invoice",value:y.invoice}),y.custom&&(0,r.jsx)("input",{type:"hidden",name:"custom",value:y.custom}),y.returnUrl&&(0,r.jsx)("input",{type:"hidden",name:"return",value:y.returnUrl}),y.cancelUrl&&(0,r.jsx)("input",{type:"hidden",name:"cancel_return",value:y.cancelUrl}),y.items.map((e,t)=>(0,r.jsxs)(s().Fragment,{children:[(0,r.jsx)("input",{type:"hidden",name:`item_name_${t+1}`,value:e.name}),(0,r.jsx)("input",{type:"hidden",name:`item_number_${t+1}`,value:e.pid}),(0,r.jsx)("input",{type:"hidden",name:`amount_${t+1}`,value:e.amount}),(0,r.jsx)("input",{type:"hidden",name:`quantity_${t+1}`,value:e.quantity})]},t)),(0,r.jsx)("button",{type:"submit",className:o().checkOutButton,disabled:p||0===e.length,children:p?"Processing...":"Checkout with PayPal"})]}),(0,r.jsx)("button",{className:o().clearButton,onClick:v,children:"Clear"})]})]})};var p=a(6761),m=a.n(p);let g={src:"/_next/static/media/shopping-cart.3cbd37d3.png",height:225,width:225,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAMAAADz0U65AAAAHlBMVEX///+2trb29vbt7e3Ozs7Hx8fp6enV1dWdnZ2Pj4/ncQJhAAAACXBIWXMAAAsTAAALEwEAmpwYAAAALklEQVR4nGNggAM2GIOFlZmNjQnEYmRkYWQBMVgZWRkhIhzsnGCFTEwMYAEoAAANGgBf2uuwwAAAAABJRU5ErkJggg==",blurWidth:8,blurHeight:8};var x=a(7325),y=a.n(x);let f=()=>{let e,[t,a]=(0,n.useState)(!1),s=(0,n.useRef)(null);return(0,r.jsxs)("div",{className:y().cart_container,onMouseEnter:()=>{clearTimeout(e),a(!0)},onMouseLeave:()=>{e=setTimeout(()=>{a(!1)},200)},ref:s,children:[(0,r.jsx)("button",{className:y().cart_button,children:(0,r.jsx)(m(),{src:g,alt:"cart",width:30,height:30})}),t&&(0,r.jsx)("div",{className:o().CartPopup,children:(0,r.jsx)(h,{})})]})}}};