(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[764],{2415:(e,t,a)=>{"use strict";a.d(t,{A:()=>n});let n=new(a(9319)).EventEmitter},3998:e=>{e.exports={CartPopup:"CartPopup_CartPopup__bexWI"}},7094:(e,t,a)=>{"use strict";a.d(t,{A:()=>y});var n=a(7876),r=a(4232),s=a(3998),i=a.n(s),o=a(2415),c=a(8230),l=a.n(c),u=a(9099);let d=()=>{let[e,t]=(0,r.useState)([]),[a,s]=(0,r.useState)([]),[c,d]=(0,r.useState)(null),[h,p]=(0,r.useState)(!1),[m,g]=(0,r.useState)(null),[x,y]=(0,r.useState)({items:[]}),f=(0,r.useRef)(null),j=(0,u.useRouter)(),k=()=>{let e=JSON.parse(localStorage.getItem("cart")||"[]").map(e=>({...e,price:"string"==typeof e.price?parseFloat(e.price):e.price}));console.log("Fetched cart items:",e),t(e)},A=async()=>{try{let e=await fetch("https://s33.ierg4210.ie.cuhk.edu.hk/api/discounts");if(!e.ok)throw Error("Failed to fetch discounts: ".concat(e.status));let t=await e.json();if(!Array.isArray(t)){console.error("Discounts response is not an array:",t),s([]);return}s(t)}catch(e){console.error("Error fetching discounts:",e),s([])}};(0,r.useEffect)(()=>(k(),A(),o.A.on("cartUpdated",k),()=>{o.A.removeListener("cartUpdated",k)}),[]);let v=()=>{localStorage.setItem("cart",JSON.stringify([])),t([]),o.A.emit("cartUpdated")},S=(a,n)=>{let r=e.map(e=>e.pid===a?{...e,quantity:n}:e);t(r),localStorage.setItem("cart",JSON.stringify(r)),o.A.emit("cartUpdated")},b=(e,t)=>{let a=parseInt(t.target.value,10);a>=1&&S(e,a)},w=a=>{d(a),setTimeout(()=>{let n=e.filter(e=>e.pid!==a);t(n),localStorage.setItem("cart",JSON.stringify(n)),o.A.emit("cartUpdated"),d(null)},300)},I=e=>{let t=a.find(t=>t.pid===e.pid);if(!t)return e.price*e.quantity;if("buy_x_get_y_free"===t.type){let{buy_quantity:a,free_quantity:n}=t.condition,r=a+n,s=Math.floor(e.quantity/r);return(s*a+e.quantity%r)*e.price}if("tiered_pricing"===t.type){let{tiers:a}=t.condition,n=a.sort((e,t)=>t.quantity-e.quantity),r=e.quantity,s=0;for(;r>0;){let e=n.find(e=>e.quantity<=r);if(!e)break;let t=Math.floor(r/e.quantity);s+=t*e.total_price,r-=t*e.quantity}return s+r*e.price}return e.price*e.quantity},N=async e=>{if(e.preventDefault(),!h){p(!0),g(null);try{let e=JSON.parse(localStorage.getItem("cart")||"[]");if(0===e.length){g("Cart is empty."),p(!1);return}let a=e.map(e=>e.pid),n=await fetch("https://s33.ierg4210.ie.cuhk.edu.hk/api/products/validate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pids:a}),credentials:"include"});if(!n.ok)throw Error("Failed to fetch product data: ".concat(n.status));let r=await n.json();console.log("Fetched products from database:",r);let s=new Map(r.map(e=>[e.pid,{name:e.name,price:parseFloat(e.price)}])),i=e.filter(e=>s.has(e.pid)).map(e=>({...e,name:s.get(e.pid).name,price:s.get(e.pid).price}));if(i.length!==e.length&&g("Some items in your cart are invalid and have been removed."),t(i),localStorage.setItem("cart",JSON.stringify(i)),o.A.emit("cartUpdated"),0===i.length){g("No valid items in cart."),p(!1);return}let c=null;console.log("Checking user session, browser cookies:",document.cookie);let l=await fetch("https://s33.ierg4210.ie.cuhk.edu.hk/api/get-user",{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});if(console.log("Get user response:",{status:l.status,headers:Object.fromEntries(l.headers.entries()),ok:l.ok,body:await l.clone().json().catch(()=>({}))}),l.ok){let e=await l.json(),t=localStorage.getItem("expectedUserId");if(t&&e.userId.toString()!==t){console.warn("User ID mismatch in checkout! Expected: ".concat(t,", Got: ").concat(e.userId,". Forcing logout.")),await fetch("https://s33.ierg4210.ie.cuhk.edu.hk/auth/logout",{method:"POST",credentials:"include"}),localStorage.setItem("loggedOut","true"),localStorage.removeItem("expectedUserId"),j.push("/login"),p(!1);return}c=e.userId||null,console.log("User fetched successfully:",e)}else if(console.warn("Failed to fetch user, status:",l.status),confirm("Please log in to proceed with checkout. Continue as guest?"))c=null;else{localStorage.setItem("redirectAfterLogin",window.location.pathname),j.push("/login"),p(!1);return}console.log("Submitting cart:",i,"User ID:",c);let u=await fetch("https://s33.ierg4210.ie.cuhk.edu.hk/api/validate-order",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({cart:i.map(e=>({pid:e.pid,quantity:e.quantity})),user_id:c})});if(!u.ok){let e=await u.json();throw Error("Order validation failed: ".concat(e.error||u.status))}let{orderId:d,digest:h}=await u.json();console.log("Order validated:",{orderId:d,digest:h}),localStorage.setItem("lastOrderId",d.toString()),y({invoice:d.toString(),custom:d.toString(),returnUrl:"https://s33.ierg4210.ie.cuhk.edu.hk/success?invoice=".concat(d),cancelUrl:"https://s33.ierg4210.ie.cuhk.edu.hk/cancel",items:i.map(e=>({name:e.name,pid:e.pid.toString(),amount:(I(e)/e.quantity).toFixed(2),quantity:e.quantity.toString()}))}),setTimeout(()=>{f.current&&document.contains(f.current)?(console.log("Submitting PayPal form via ref:",f.current.outerHTML),f.current.submit(),v()):(console.error("Form is not connected to the DOM"),g("Failed to submit payment form. Please try again."),p(!1))},100)}catch(e){console.error("Checkout error:",e),g("System error. Please try again later."),p(!1)}}},_=e.reduce((e,t)=>e+I(t),0);return(0,n.jsxs)("div",{className:i().CartPopup,children:[(0,n.jsx)("h4",{children:"Shopping Cart"}),m&&(0,n.jsx)("p",{className:i().Error,children:m}),(0,n.jsx)("ul",{children:e.map(e=>(0,n.jsxs)("li",{className:"".concat(i().CartItem," ").concat(e.pid===c?i().removing:""),children:[(0,n.jsx)(l(),{href:"/product/".concat(e.pid),children:(0,n.jsx)("span",{className:i().ItemName,children:e.name})}),(0,n.jsx)("input",{type:"number",value:e.quantity,min:"1",onChange:t=>b(e.pid,t),className:i().QuantityInput}),(0,n.jsx)("span",{className:i().ItemTime,children:"\xd7"}),(0,n.jsxs)("span",{className:i().ItemPrice,children:["$",e.price.toFixed(2)]}),(0,n.jsx)("span",{className:i().ItemEqual,children:"="}),(0,n.jsxs)("span",{className:i().ItemTotal,children:["$",I(e).toFixed(2)]}),(0,n.jsx)("button",{className:i().ItemRemove,onClick:()=>w(e.pid),children:"-"})]},e.pid))}),0===e.length&&(0,n.jsx)("p",{children:"Your cart is empty."}),(0,n.jsx)("hr",{}),(0,n.jsxs)("h2",{className:i().TotalPrice,children:["Total: $",_.toFixed(2)]}),(0,n.jsxs)("div",{className:i().ButtonContainer,children:[(0,n.jsxs)("form",{id:"paypal-form",ref:f,action:"https://www.sandbox.paypal.com/cgi-bin/webscr",method:"post",onSubmit:N,children:[(0,n.jsx)("input",{type:"hidden",name:"cmd",value:"_cart"}),(0,n.jsx)("input",{type:"hidden",name:"upload",value:"1"}),(0,n.jsx)("input",{type:"hidden",name:"business",value:"sb-6odog38870896@business.example.com"}),(0,n.jsx)("input",{type:"hidden",name:"charset",value:"utf-8"}),(0,n.jsx)("input",{type:"hidden",name:"currency_code",value:"USD"}),x.invoice&&(0,n.jsx)("input",{type:"hidden",name:"invoice",value:x.invoice}),x.custom&&(0,n.jsx)("input",{type:"hidden",name:"custom",value:x.custom}),x.returnUrl&&(0,n.jsx)("input",{type:"hidden",name:"return",value:x.returnUrl}),x.cancelUrl&&(0,n.jsx)("input",{type:"hidden",name:"cancel_return",value:x.cancelUrl}),x.items.map((e,t)=>(0,n.jsxs)(r.Fragment,{children:[(0,n.jsx)("input",{type:"hidden",name:"item_name_".concat(t+1),value:e.name}),(0,n.jsx)("input",{type:"hidden",name:"item_number_".concat(t+1),value:e.pid}),(0,n.jsx)("input",{type:"hidden",name:"amount_".concat(t+1),value:e.amount}),(0,n.jsx)("input",{type:"hidden",name:"quantity_".concat(t+1),value:e.quantity})]},t)),(0,n.jsx)("button",{type:"submit",className:i().checkOutButton,disabled:h||0===e.length,children:h?"Processing...":"Checkout with PayPal"})]}),(0,n.jsx)("button",{className:i().clearButton,onClick:v,children:"Clear"})]})]})};var h=a(4587),p=a.n(h);let m={src:"/_next/static/media/shopping-cart.3cbd37d3.png",height:225,width:225,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAMAAADz0U65AAAAHlBMVEX///+2trb29vbt7e3Ozs7Hx8fp6enV1dWdnZ2Pj4/ncQJhAAAACXBIWXMAAAsTAAALEwEAmpwYAAAALklEQVR4nGNggAM2GIOFlZmNjQnEYmRkYWQBMVgZWRkhIhzsnGCFTEwMYAEoAAANGgBf2uuwwAAAAABJRU5ErkJggg==",blurWidth:8,blurHeight:8};var g=a(7660),x=a.n(g);let y=()=>{let e,[t,a]=(0,r.useState)(!1),s=(0,r.useRef)(null);return(0,n.jsxs)("div",{className:x().cart_container,onMouseEnter:()=>{clearTimeout(e),a(!0)},onMouseLeave:()=>{e=setTimeout(()=>{a(!1)},200)},ref:s,children:[(0,n.jsx)("button",{className:x().cart_button,children:(0,n.jsx)(p(),{src:m,alt:"cart",width:30,height:30})}),t&&(0,n.jsx)("div",{className:i().CartPopup,children:(0,n.jsx)(d,{})})]})}},7660:e=>{e.exports={cart_container:"CartButton_cart_container__5vrp7",cart_button:"CartButton_cart_button__8zPgj"}},9765:(e,t,a)=>{"use strict";a.d(t,{A:()=>l});var n=a(7876),r=a(4232),s=a(8230),i=a.n(s),o=a(1040),c=a(9099);let l=()=>{let[e,t]=(0,r.useState)(null),a=(0,c.useRouter)();(0,r.useEffect)(()=>{(async()=>{if("true"===localStorage.getItem("loggedOut")){console.log("Skipping auth check due to recent logout"),t("Guest");return}try{console.log("Checking user, browser cookies:",document.cookie);let e=await o.A.get("https://s33.ierg4210.ie.cuhk.edu.hk/auth/user",{withCredentials:!0});console.log("Fetched user:",e.data);let n=localStorage.getItem("expectedUserId");if(n&&e.data.userId.toString()!==n){console.warn("User ID mismatch! Expected: ".concat(n,", Got: ").concat(e.data.userId,". Multiple authToken cookies may exist.")),await o.A.post("https://s33.ierg4210.ie.cuhk.edu.hk/auth/logout",{},{withCredentials:!0}),localStorage.setItem("loggedOut","true"),t("Guest"),a.push("/login");return}t("admin"===e.data.role?"Admin":"User")}catch(a){var e;console.error("User not authenticated:",(null==(e=a.response)?void 0:e.data)||a),t("Guest")}})()},[a]);let s=async()=>{try{console.log("Sending logout request, browser cookies:",document.cookie);let e=await o.A.post("https://s33.ierg4210.ie.cuhk.edu.hk/auth/logout",{},{withCredentials:!0});console.log("Logout response:",e.data),t("Guest"),localStorage.setItem("loggedOut","true"),localStorage.removeItem("expectedUserId"),localStorage.removeItem("lastLogin"),localStorage.removeItem("redirectAfterLogin"),document.cookie="authToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="sessionID=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="authToken=; Path=/auth; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="sessionID=; Path=/auth; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="authToken=; Path=/api; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="sessionID=; Path=/api; Expires=Thu, 01 Jan 1970 00:00:00 GMT",a.push("/login")}catch(t){var e;console.error("Logout failed:",(null==(e=t.response)?void 0:e.data)||t)}};return(0,n.jsx)("header",{children:(0,n.jsxs)("nav",{className:"navbar",children:[(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:(0,n.jsx)(i(),{href:"/",children:"Home"})}),(0,n.jsxs)("li",{className:"category",children:[(0,n.jsx)("a",{href:"#",children:"Category"}),(0,n.jsxs)("ul",{className:"cate",children:[(0,n.jsx)("li",{children:(0,n.jsx)(i(),{href:"/smartphone",children:"Smartphone"})}),(0,n.jsx)("li",{children:(0,n.jsx)(i(),{href:"/laptop",children:"Laptop"})})]})]}),(0,n.jsx)("li",{children:(0,n.jsx)(i(),{href:"/member-portal",children:"Member Portal"})}),"Admin"===e&&(0,n.jsx)("li",{children:(0,n.jsx)(i(),{href:"/admin",children:"Admin Panel"})})]}),(0,n.jsx)("div",{className:"user-actions",children:null===e?(0,n.jsx)("span",{children:"Loading..."}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("span",{className:"user-greeting",children:["Welcome, ",e]}),"Guest"!==e?(0,n.jsx)("button",{className:"logout-btn",onClick:s,children:"Logout"}):(0,n.jsx)(i(),{href:"/login",children:(0,n.jsx)("button",{className:"login-btn",children:"Login"})}),(0,n.jsx)(i(),{href:"/changepwd",children:(0,n.jsx)("button",{className:"pwd",children:"Reset"})})]})})]})})}}}]);