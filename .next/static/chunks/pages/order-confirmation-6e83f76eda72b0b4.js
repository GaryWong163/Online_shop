(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[246],{1971:e=>{e.exports={container:"OrderConfirmation_container___sk_C",main:"OrderConfirmation_main__bIKD0",success:"OrderConfirmation_success__k4ZV3",pending:"OrderConfirmation_pending__9YQZs",error:"OrderConfirmation_error__DKkQs",checkButton:"OrderConfirmation_checkButton__olyLi",backButton:"OrderConfirmation_backButton__G88Sj"}},7036:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/order-confirmation",function(){return r(9417)}])},7328:(e,t,r)=>{e.exports=r(9836)},9417:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>d});var o=r(7876),a=r(9099),s=r(4232),n=r(7328),c=r.n(n),i=r(9765),l=r(1971),u=r.n(l);let d=()=>{let e=(0,a.useRouter)(),{status:t,reason:r,orderId:n}=e.query,[l,d]=(0,s.useState)(""),[h,m]=(0,s.useState)(!1);(0,s.useEffect)(()=>{let e="";switch(t){case"success":e="Thank you for your order! Your payment has been successfully processed.";break;case"cancelled":e="Your order has been cancelled. No charges have been made.";break;case"error":switch(r){case"missing_invoice":e="Error: Missing order ID. Please contact support with your payment details.";break;case"no_transaction":e="Error: No transaction found for your order (Order ID: ".concat(n||"Unknown","). It may still be processing. Checking status...");break;case"no_order":e="Error: Order not found (Order ID: ".concat(n||"Unknown","). Please contact support.");break;case"server_error":e="Error: A server error occurred. Please contact support.";break;default:if(r&&r.toString().startsWith("payment_status_")){let t=r.toString().replace("payment_status_","");e="Error: Payment status is ".concat(t," (Order ID: ").concat(n||"Unknown","). Please contact support.")}else e="Error: An unexpected error occurred (Order ID: ".concat(n||"Unknown","). Please contact support.")}break;default:e="Error: Invalid order status. Please contact support."}d(e)},[t,r,n]),(0,s.useEffect)(()=>{"error"===t&&"no_transaction"===r&&n&&!h&&(async()=>{m(!0);for(let t=1;t<=12;t++){try{console.log("Checking transaction status, attempt ".concat(t,"/12 for orderId: ").concat(n));let r=await fetch("/api/check-transaction?orderId=".concat(n)),o=await r.json();if(r.ok&&o.paymentStatus){console.log("Transaction status:",o.paymentStatus);let t=o.paymentStatus.toLowerCase();if("completed"===t)return void e.push("/order-confirmation?status=success");return void d("Error: Payment status is ".concat(o.paymentStatus," (Order ID: ").concat(n,"). Please contact support."))}console.log("No transaction found on attempt ".concat(t,"/12"))}catch(e){console.error("Check transaction error:",e)}await new Promise(e=>setTimeout(e,5e3))}d("Error: No transaction found for your order (Order ID: ".concat(n,"). Please contact support.")),m(!1)})()},[t,r,n,e,h]);let p=async()=>{if(n&&!h){m(!0);try{console.log("Manual check for transaction status, orderId: ".concat(n));let t=await fetch("/api/check-transaction?orderId=".concat(n)),r=await t.json();if(t.ok&&r.paymentStatus){console.log("Transaction status:",r.paymentStatus);let t=r.paymentStatus.toLowerCase();"completed"===t?e.push("/order-confirmation?status=success"):d("Error: Payment status is ".concat(r.paymentStatus," (Order ID: ").concat(n,"). Please contact support."))}else d("Error: Unable to check transaction status (Order ID: ".concat(n,"). Please try again later."))}catch(e){console.error("Check transaction error:",e),d("Error: Unable to check transaction status (Order ID: ".concat(n,"). Please try again later."))}finally{m(!1)}}};return(0,o.jsxs)("div",{className:u().container,children:[(0,o.jsxs)(c(),{children:[(0,o.jsx)("title",{children:"Order Confirmation - ".concat(l)}),(0,o.jsx)("meta",{name:"description",content:"Order confirmation status"})]}),(0,o.jsx)(i.A,{}),(0,o.jsxs)("main",{className:u().main,children:[(0,o.jsx)("h1",{children:"Order Confirmation"}),(0,o.jsx)("p",{className:"success"===t?u().success:u().error,children:l}),"no_transaction"===r&&n&&(0,o.jsx)("button",{className:u().checkButton,onClick:p,disabled:h,children:h?"Checking...":"Check Transaction Status Again"}),(0,o.jsx)("button",{className:u().backButton,onClick:()=>e.push("/"),children:"Back to Home"})]})]})}},9765:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});var o=r(7876),a=r(4232),s=r(8230),n=r.n(s),c=r(1040),i=r(9099);let l=()=>{let[e,t]=(0,a.useState)(null),r=(0,i.useRouter)();(0,a.useEffect)(()=>{(async()=>{if("true"===localStorage.getItem("loggedOut")){console.log("Skipping auth check due to recent logout"),t("Guest");return}try{console.log("Checking user, browser cookies:",document.cookie);let e=await c.A.get("https://s33.ierg4210.ie.cuhk.edu.hk/auth/user",{withCredentials:!0});console.log("Fetched user:",e.data);let o=localStorage.getItem("expectedUserId");if(o&&e.data.userId.toString()!==o){console.warn("User ID mismatch! Expected: ".concat(o,", Got: ").concat(e.data.userId,". Multiple authToken cookies may exist.")),await c.A.post("https://s33.ierg4210.ie.cuhk.edu.hk/auth/logout",{},{withCredentials:!0}),localStorage.setItem("loggedOut","true"),t("Guest"),r.push("/login");return}t("admin"===e.data.role?"Admin":"User")}catch(r){var e;console.error("User not authenticated:",(null==(e=r.response)?void 0:e.data)||r),t("Guest")}})()},[r]);let s=async()=>{try{console.log("Sending logout request, browser cookies:",document.cookie);let e=await c.A.post("https://s33.ierg4210.ie.cuhk.edu.hk/auth/logout",{},{withCredentials:!0});console.log("Logout response:",e.data),t("Guest"),localStorage.setItem("loggedOut","true"),localStorage.removeItem("expectedUserId"),localStorage.removeItem("lastLogin"),localStorage.removeItem("redirectAfterLogin"),document.cookie="authToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="sessionID=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="authToken=; Path=/auth; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="sessionID=; Path=/auth; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="authToken=; Path=/api; Expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="sessionID=; Path=/api; Expires=Thu, 01 Jan 1970 00:00:00 GMT",r.push("/login")}catch(t){var e;console.error("Logout failed:",(null==(e=t.response)?void 0:e.data)||t)}};return(0,o.jsx)("header",{children:(0,o.jsxs)("nav",{className:"navbar",children:[(0,o.jsxs)("ul",{children:[(0,o.jsx)("li",{children:(0,o.jsx)(n(),{href:"/",children:"Home"})}),(0,o.jsxs)("li",{className:"category",children:[(0,o.jsx)("a",{href:"#",children:"Category"}),(0,o.jsxs)("ul",{className:"cate",children:[(0,o.jsx)("li",{children:(0,o.jsx)(n(),{href:"/smartphone",children:"Smartphone"})}),(0,o.jsx)("li",{children:(0,o.jsx)(n(),{href:"/laptop",children:"Laptop"})})]})]}),(0,o.jsx)("li",{children:(0,o.jsx)(n(),{href:"/member-portal",children:"Member Portal"})}),"Admin"===e&&(0,o.jsx)("li",{children:(0,o.jsx)(n(),{href:"/admin",children:"Admin Panel"})})]}),(0,o.jsx)("div",{className:"user-actions",children:null===e?(0,o.jsx)("span",{children:"Loading..."}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("span",{className:"user-greeting",children:["Welcome, ",e]}),"Guest"!==e?(0,o.jsx)("button",{className:"logout-btn",onClick:s,children:"Logout"}):(0,o.jsx)(n(),{href:"/login",children:(0,o.jsx)("button",{className:"login-btn",children:"Login"})}),(0,o.jsx)(n(),{href:"/changepwd",children:(0,o.jsx)("button",{className:"pwd",children:"Reset"})})]})})]})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[846,230,636,593,792],()=>t(7036)),_N_E=e.O()}]);